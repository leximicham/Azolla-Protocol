@startuml mec_state_machine
' MEC v0.1 state machine with per-schema artifact state snapshots.

hide empty description

state "Ticket Created (Needs Review)\n---\nticket.status = NEW\nevent = absent\ncontext_snapshot = absent\nworkorder = absent\noutput_bundle = absent\nrun_record = absent\npause_state = absent" as TicketCreated

state "Ticket Approved for Scheduling\n---\nticket.status = TODO\nevent = absent\ncontext_snapshot = absent\nworkorder = absent\noutput_bundle = absent\nrun_record = absent\npause_state = absent" as TicketApproved

state "Ready Event Emitted\n---\nticket.status = TODO\nevent.type = TICKET_READY\nevent.processed = false\ncontext_snapshot = absent\nworkorder = absent\noutput_bundle = absent\nrun_record = absent\npause_state = absent" as ReadyEventEmitted

state "Terminal Event Processed\n---\nevent.processed = true\n(no run artifacts created)" as TerminalEventProcessed

state "Missing Ticket Terminal\n---\nprocessing outcome = MISSING_TICKET\nticket = not found\nevent.processed = true" as MissingTicketTerminal

state "Non-Executable Terminal\n---\nprocessing outcome = NON_EXECUTABLE_STATUS\nticket.status != TODO\nevent.processed = true" as NonExecutableTerminal

state "Blocked Terminal\n---\nprocessing outcome = BLOCKED\nticket.status = BLOCKED\nticket.blocked_on has entries\nevent.processed = true" as BlockedTerminal

state "Work Scheduled\n---\nticket.status = IN_PROGRESS\nevent.processed = true\ncontext_snapshot = persisted (immutable)\nworkorder.status = CREATED\noutput_bundle = absent\nrun_record = absent\npause_state = absent" as WorkScheduled

state "Execution Output Produced\n---\nticket.status = IN_PROGRESS\nworkorder.status = EXECUTED\noutput_bundle = persisted (immutable)\nrun_record = absent\npause_state = absent" as ExecutionOutputProduced

state "Gate PASS Recorded\n---\nrun_record.gate_result = PASS\nrun_record.commit_sha = <sha>\nticket.status -> DONE" as GatePassRecorded

state "Gate FAIL Recorded\n---\nrun_record.gate_result = FAIL\nrun_record.commit_sha = null|string\nticket.status -> BLOCKED|TODO" as GateFailRecorded

state "Budget Exhausted\n---\nworkorder.status = CREATED|EXECUTED\nrun_record = optional/implementation-defined\nticket.status = IN_PROGRESS|BLOCKED" as BudgetExhausted

state "Paused (Run Complete)\n---\npause_state.reason = RUN_COMPLETE\npause_state.prioritized_actions = 1..3\nticket.status = DONE" as PausedRunComplete

state "Paused (Gate Failed)\n---\npause_state.reason = GATE_FAILED\npause_state.prioritized_actions = 1..3\nticket.status = BLOCKED|TODO" as PausedGateFailed

state "Paused (Budget Exhausted)\n---\npause_state.reason = BUDGET_EXHAUSTED\npause_state.prioritized_actions = 1..3\nticket.status = IN_PROGRESS|BLOCKED" as PausedBudgetExhausted

[*] --> TicketCreated
TicketCreated --> TicketApproved : human validates requirements
TicketApproved --> ReadyEventEmitted : emit TICKET_READY

ReadyEventEmitted --> MissingTicketTerminal : MISSING_TICKET
ReadyEventEmitted --> NonExecutableTerminal : NON_EXECUTABLE_STATUS
ReadyEventEmitted --> BlockedTerminal : BLOCKED
ReadyEventEmitted --> WorkScheduled : executable

MissingTicketTerminal --> TerminalEventProcessed
NonExecutableTerminal --> TerminalEventProcessed
BlockedTerminal --> TerminalEventProcessed
TerminalEventProcessed --> [*]

WorkScheduled --> ExecutionOutputProduced : run diazotroph
ExecutionOutputProduced --> GatePassRecorded : gate_result=PASS
ExecutionOutputProduced --> GateFailRecorded : gate_result=FAIL
WorkScheduled --> BudgetExhausted : budget expires before completion
ExecutionOutputProduced --> BudgetExhausted : budget expires post-output

GatePassRecorded --> PausedRunComplete
GateFailRecorded --> PausedGateFailed
BudgetExhausted --> PausedBudgetExhausted

PausedRunComplete --> [*]
PausedGateFailed --> [*]
PausedBudgetExhausted --> [*]

@enduml
