@startuml task_mgmt_state_machine
' Task Management Azolla v0.2 State Machine
' Three lifecycle tracks with terminal pause_states.

hide empty description

' === Track A: Triage ===

state "Capture Created\n---\ncapture_buffer.status = PENDING\nevent = absent" as CaptureCreated

state "Capture Ready Event Emitted\n---\nevent.type = CAPTURE_READY\nevent.processed = false" as CaptureReadyEmitted

state "Triage Scheduled\n---\nevent.processed = true\ncontext_snapshot = persisted\nworkorder.status = CREATED\nworkorder.diazotroph_type = TRIAGE_DIAZOTROPH" as TriageScheduled

state "Triage Output Produced\n---\nworkorder.status = EXECUTED\noutput_bundle = persisted" as TriageOutputProduced

state "Triage Gate PASS\n---\nrun_record.gate_result = PASS\ncapture_buffer.status = PROCESSED" as TriageGatePass

state "Triage Gate FAIL\n---\nrun_record.gate_result = FAIL" as TriageGateFail

state "Paused (Triage Complete)\n---\npause_state.reason = RUN_COMPLETE" as PausedTriageComplete

state "Paused (Triage Failed)\n---\npause_state.reason = GATE_FAILED" as PausedTriageFailed

state "Paused (Triage Budget Exhausted)\n---\npause_state.reason = BUDGET_EXHAUSTED" as PausedTriageBudget

[*] --> CaptureCreated
CaptureCreated --> CaptureReadyEmitted : Capture Readiness Worker emits CAPTURE_READY
CaptureReadyEmitted --> TriageScheduled : Scheduler claims event, creates workorder
TriageScheduled --> TriageOutputProduced : Runner executes TRIAGE_DIAZOTROPH
TriageScheduled --> PausedTriageBudget : budget_ms exceeded
TriageOutputProduced --> TriageGatePass : gate_result = PASS
TriageOutputProduced --> TriageGateFail : gate_result = FAIL
TriageGatePass --> PausedTriageComplete
TriageGateFail --> PausedTriageFailed
PausedTriageComplete --> [*]
PausedTriageFailed --> [*]
PausedTriageBudget --> [*]

' === Track B: Manifest Build ===

state "Manifest Requested\n---\nevent.type = MANIFEST_REQUESTED\nevent.processed = false" as ManifestRequested

state "Manifest Scheduled\n---\nevent.processed = true\ncontext_snapshot = persisted\n(includes cross-azolla data)\nworkorder.status = CREATED\nworkorder.diazotroph_type = MANIFEST_BUILDER_DIAZOTROPH" as ManifestScheduled

state "Manifest Produced\n---\nworkorder.status = EXECUTED\noutput_bundle = persisted" as ManifestProduced

state "Manifest Gate PASS\n---\nrun_record.gate_result = PASS" as ManifestGatePass

state "Manifest Gate FAIL\n---\nrun_record.gate_result = FAIL" as ManifestGateFail

state "Paused (Manifest Complete)\n---\npause_state.reason = RUN_COMPLETE" as PausedManifestComplete

state "Paused (Manifest Failed)\n---\npause_state.reason = GATE_FAILED" as PausedManifestFailed

state "Paused (Manifest Budget Exhausted)\n---\npause_state.reason = BUDGET_EXHAUSTED" as PausedManifestBudget

[*] --> ManifestRequested : operator requests orientation or periodic trigger
ManifestRequested --> ManifestScheduled : Manifest Scheduler claims, queries azollas, creates workorder
ManifestScheduled --> ManifestProduced : Runner executes MANIFEST_BUILDER_DIAZOTROPH
ManifestScheduled --> PausedManifestBudget : budget_ms exceeded
ManifestProduced --> ManifestGatePass : gate_result = PASS
ManifestProduced --> ManifestGateFail : gate_result = FAIL
ManifestGatePass --> PausedManifestComplete
ManifestGateFail --> PausedManifestFailed
PausedManifestComplete --> [*]
PausedManifestFailed --> [*]
PausedManifestBudget --> [*]

' === Track C: Deadline Monitoring ===

state "Objective Active\n---\nobjective.urgency in 0..4\ndeadline derived from deployment config" as ObjectiveActive

state "Deadline Overdue\n---\nurgency-derived deadline exceeded" as DeadlineOverdue

state "Paused (Deadline Overdue)\n---\npause_state with overdue action items" as PausedDeadlineOverdue

ObjectiveActive --> DeadlineOverdue : urgency-derived deadline exceeded
DeadlineOverdue --> PausedDeadlineOverdue : local pause_state written
PausedDeadlineOverdue --> [*]

@enduml
